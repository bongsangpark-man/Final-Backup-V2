<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
      /* --- [ìŠ¤íƒ€ì¼] ê¸°ë³¸ ì„¤ì • --- */
      :root { --primary: #1a73e8; --bg: #f8f9fa; --text: #202124; --border: #dadce0; }
      body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); font-size: 13px; }
      
      /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
      .tab-container { position: sticky; top: 0; background: white; z-index: 10; border-bottom: 1px solid #eee; }
      .tab { display: flex; }
      .tab button { flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; font-weight: 500; color: #5f6368; cursor: pointer; transition: 0.2s; }
      .tab button.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }
      .tabcontent { display: none; padding: 15px; animation: fadeEffect 0.3s; }
      @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

      /* ì¹´ë“œ ë°•ìŠ¤ */
      .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #eee; }
      .card h3 { margin: 0 0 10px 0; font-size: 15px; color: var(--primary); display: flex; align-items: center; gap: 5px; }
      
      /* ì…ë ¥ì°½ ë° ë²„íŠ¼ */
      label { display: block; margin: 10px 0 4px; font-weight: 500; color: #5f6368; font-size: 12px; }
      input, select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 13px; background: #fff; transition: 0.2s; }
      input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
      
      .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
      .btn-primary:hover { background: #1557b0; }
      .btn-small { background: #e8f0fe; color: var(--primary); border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; margin-top: 5px; display: inline-flex; align-items: center; gap: 3px; }
      
      /* ìœ í‹¸ë¦¬í‹° */
      .hidden { display: none !important; }
      .row { display: flex; gap: 8px; }
      .col { flex: 1; }
      .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f1f3f4; padding: 12px; border-radius: 6px; }
      .checkbox-item { display: flex; align-items: center; font-size: 12px; cursor: pointer; user-select: none; }
      .checkbox-item input { width: auto; margin-right: 8px; }
      .current-value-info { font-size: 11px; color: #d93025; margin-left: 4px; font-weight: normal; }
      .section-divider { border: 0; border-top: 1px solid #eee; margin: 20px 0; }

      /* â˜… [ì •ì‚°ì„œ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼] â˜… */
      #settlement_overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #f0f7ff;
        z-index: 100;
        padding: 15px;
        box-sizing: border-box;
        overflow-y: auto;
        display: none;
      }
      #settlement_overlay.active { display: block; animation: slideUp 0.3s; }
      @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

      .settle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
      .settle-header h2 { margin: 0; color: #1a73e8; font-size: 18px; display: flex; align-items: center; gap:5px; }
    </style>
  </head>
  <body>
    
    <div class="tab-container">
      <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'Modify')">ê¸°ì¡´ ì •ë³´ ìˆ˜ì •</button>
        <button class="tablinks" onclick="openTab(event, 'Change')">ì„¸ì…ì ë³€ê²½/ì‹ ê·œ</button>
      </div>
    </div>

    <div id="Modify" class="tabcontent" style="display: block;">
      <div class="card">
        <h3><i class="material-icons">edit</i>ìˆ˜ì • ëŒ€ìƒ ì„ íƒ</h3>
        <label>í˜¸ìˆ˜ ì„ íƒ</label>
        <select id="mod_hosu" onchange="loadModData()"></select>
        
        <div id="mod_form_area" class="hidden" style="margin-top:20px;">
          <label style="margin-bottom:8px;">ìˆ˜ì •í•  í•­ëª© ì²´í¬</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="bizNum">ì‚¬ì—…ìë²ˆí˜¸</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="deposit2">ì„ëŒ€ë³´ì¦ê¸ˆ</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="rent">ì›”ì„ëŒ€ë£Œ</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="period">ì„ëŒ€ê¸°ê°„</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="tenant">ê³„ì•½ì</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="resNo">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label> 
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="phone">ì—°ë½ì²˜</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="parking">ì£¼ì°¨</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="out">ì¤‘ë„í‡´ì‹¤</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="food">ìŒì‹ë¬¼ì¹´ë“œ</label>
            <label class="checkbox-item"><input type="checkbox" class="mod-chk" value="trust">ì‹ íƒë™ì˜</label>
          </div>
          
          <div class="section-divider"></div>
          
          <form id="modForm">
            <div id="mod_dynamic_inputs"></div>
          </form>

          <button type="button" class="btn-primary" onclick="submitModify()">ìˆ˜ì • ë‚´ì—­ ì €ì¥</button>
        </div>
      </div>
    </div>

    <div id="Change" class="tabcontent">
      <div class="card">
        <h3><i class="material-icons">autorenew</i>ë³€ê²½ ëŒ€ìƒ ì„ íƒ</h3>
        <label>í˜¸ìˆ˜ ì„ íƒ</label>
        <select id="chg_hosu" onchange="checkVacancy()"></select>
        <div id="status_indicator" style="font-size:12px; margin-top:8px; font-weight:bold; padding:8px; background:#f1f3f4; border-radius:4px;"></div>
        
        <div id="exit_date_area" class="hidden">
          <label style="color:#d93025">ê¸°ì¡´ ì„¸ì…ì í‡´ì‹¤ì¼ (í•„ìˆ˜)</label>
          <input type="date" id="exitDate">
        </div>
      </div>

      <div id="new_info_area" class="card hidden">
        <h3><i class="material-icons">add_circle_outline</i>ì‹ ê·œ ê³„ì•½ ì •ë³´</h3>
        <label>ê³„ì•½ ìœ í˜•</label>
        <select id="newType" onchange="renderNewForm()">
          <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì›”ì„¸(ì„ ë¶ˆ)">ì›”ì„¸(ì„ ë¶ˆ)</option>
          <option value="ì›”ì„¸(í›„ë¶ˆ)">ì›”ì„¸(í›„ë¶ˆ)</option>
          <option value="ì „ì„¸">ì „ì„¸</option>
          <option value="ë§¤ë§¤">ë§¤ë§¤</option>
          <option value="ê³µì‹¤">ê³µì‹¤ (ë¹„ìš°ê¸°)</option>
        </select>

        <form id="changeForm">
          <div id="chg_dynamic_inputs" style="margin-top:15px;"></div>
        </form>
        
        <button type="button" class="btn-primary" onclick="submitChange()">ë³€ê²½ ì ìš©í•˜ê¸°</button>
      </div>
    </div>


    <div id="settlement_overlay">
      <div class="settle-header">
        <h2><i class="material-icons">calculate</i> í‡´ì‹¤ ì •ì‚°ì„œ ì‘ì„±</h2>
        <button onclick="closeSettlement()" style="font-size:20px; border:none; background:none; cursor:pointer;">âœ•</button>
      </div>
      
      <div class="card">
        <p id="settle_info_msg" style="color:#1a73e8; font-weight:bold; margin-bottom:10px;"></p>
        
        <h4 style="margin:5px 0;">ğŸ”µ ì„ì°¨ì¸ ë°˜í™˜ê¸ˆ</h4>
        <label>ì„ëŒ€ ë³´ì¦ê¸ˆ</label>
        <input type="text" id="set_deposit" placeholder="0" oninput="formatMoney(this); calcTotalRefund()">
        
        <div id="prepaid_rent_area" class="hidden" style="margin-top:5px; padding:5px; background:#e8f0fe; border-radius:4px;">
           <label style="color:#1a73e8;">(+) ì„ ë¶ˆ ì„ëŒ€ë£Œ ë°˜í™˜</label>
           <input type="text" id="set_refund_prepaid" placeholder="0" oninput="formatMoney(this); calcTotalRefund()">
        </div>

        <div class="section-divider"></div>

        <h4 style="margin:5px 0;">ğŸ”´ ê³µì œ ë‚´ì—­</h4>
        
        <label>ì„ëŒ€ë£Œ ì •ì‚° <span id="rent_period_hint" style="font-size:11px; color:#666;"></span></label>
        <div class="row">
          <div class="col" style="flex:2"><input type="text" id="set_rent_deduct" placeholder="ê¸ˆì•¡" oninput="formatMoney(this); calcTotalRefund()"></div>
          <div class="col" style="flex:3"><input type="text" id="set_rent_period" placeholder="ê¸°ê°„ (yy/mm/dd~)"></div>
        </div>

        <label>ê´€ë¦¬ë¹„ ì •ì‚° <span id="maint_period_hint" style="font-size:11px; color:#666;"></span></label>
        <div class="row">
          <div class="col" style="flex:2"><input type="text" id="set_maint_deduct" placeholder="ê¸ˆì•¡" oninput="formatMoney(this); calcTotalRefund()"></div>
          <div class="col" style="flex:3"><input type="text" id="set_maint_period" placeholder="ê¸°ê°„"></div>
        </div>

        <label style="margin-top:10px;">ê³µê³¼ê¸ˆ ì •ì‚° ë°©ì‹</label>
        <div class="checkbox-group" style="grid-template-columns: 1fr 1fr; margin-bottom:5px;">
           <label class="checkbox-item"><input type="radio" name="util_method" value="direct" onclick="toggleUtilInput(false)" checked>ì§ì ‘ ì •ì‚°</label>
           <label class="checkbox-item"><input type="radio" name="util_method" value="office" onclick="toggleUtilInput(true)">ê´€ë¦¬ì‹¤ ì •ì‚°</label>
        </div>
        
        <div id="util_inputs" class="hidden">
           <div class="row">
             <div class="col">
               <label>ì „ê¸° <span id="util_elec_period" style="font-size:10px; color:#666;"></span></label>
               <input type="text" id="util_elec" oninput="formatMoney(this); calcTotalRefund()">
             </div>
             <div class="col">
               <label>ê°€ìŠ¤ <span id="util_gas_period" style="font-size:10px; color:#666;"></span></label>
               <input type="text" id="util_gas" oninput="formatMoney(this); calcTotalRefund()">
             </div>
           </div>
           <div class="row" style="margin-top:5px;">
             <div class="col">
               <label>ìˆ˜ë„ <span id="util_water_period" style="font-size:10px; color:#666;"></span></label>
               <input type="text" id="util_water" oninput="formatMoney(this); calcTotalRefund()">
             </div>
           </div>
        </div>

        <label style="margin-top:10px;">ë¶€ë™ì‚° ìˆ˜ìˆ˜ë£Œ</label>
        <select id="broker_opt" onchange="calcBrokerFee()">
           <option value="none">ì—†ìŒ</option>
           <option value="direct">ì§ì ‘ ì •ì‚° (ì…ë ¥)</option>
           <option value="office">ê´€ë¦¬ì‹¤ ì •ì‚° (ìë™ê³„ì‚°)</option>
        </select>
        <input type="text" id="set_broker_fee" class="hidden" placeholder="ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡" oninput="formatMoney(this); calcTotalRefund()" style="margin-top:5px; font-weight:bold; color:#1a73e8;">

        <label style="margin-top:10px;">í•˜ìë³´ìˆ˜ ë° ê¸°íƒ€</label>
        <div class="checkbox-group">
           <label class="checkbox-item"><input type="checkbox" id="chk_clean" onchange="toggleFixCost('clean', 300000)">ì²­ì†Œë¹„ (30ë§Œ)</label>
           <label class="checkbox-item"><input type="checkbox" id="chk_filter" onchange="toggleFixCost('filter', 30000)">í•„í„° (3ë§Œ)</label>
        </div>
        <div id="as_list"></div> <button type="button" class="btn-small" onclick="addAsItem()">+ A/S í•­ëª© ì¶”ê°€</button>

        <label style="margin-top:10px;">ìœ ë³´ê¸ˆ (10ë§Œ)</label>
        <input type="text" id="set_retained" value="100,000" oninput="formatMoney(this); calcTotalRefund()">

        <div class="section-divider"></div>

        <h4 style="margin:5px 0;">ğŸ“ ê³„ì¢Œ ë° ì¸ìˆ˜</h4>
        <label>ì„ì°¨ì¸ ê³„ì¢Œ</label>
        <div class="row">
           <div class="col" style="flex:1">
             <select id="bank_name">
               <option value="ìš°ë¦¬">ìš°ë¦¬</option><option value="êµ­ë¯¼">êµ­ë¯¼</option><option value="ì‹ í•œ">ì‹ í•œ</option><option value="í•˜ë‚˜">í•˜ë‚˜</option><option value="ë†í˜‘">ë†í˜‘</option><option value="ê¸°ì—…">ê¸°ì—…</option><option value="ì¹´ì¹´ì˜¤">ì¹´ì¹´ì˜¤</option><option value="í† ìŠ¤">í† ìŠ¤</option>
             </select>
           </div>
           <div class="col" style="flex:2"><input type="text" id="bank_account" placeholder="ê³„ì¢Œë²ˆí˜¸"></div>
        </div>
        <input type="text" id="bank_owner" placeholder="ì˜ˆê¸ˆì£¼" style="margin-top:5px;">

        <label style="margin-top:10px;">ì¸ìˆ˜ ì—¬ë¶€ í™•ì¸ (ì²´í¬=O)</label>
        <div class="checkbox-group" style="grid-template-columns: 1fr 1fr;">
           <label class="checkbox-item"><input type="checkbox" id="chk_key" checked>ì¹´ë“œí‚¤</label>
           <label class="checkbox-item"><input type="checkbox" id="chk_food" checked>ìŒì‹ë¬¼ì¹´ë“œ</label>
           <label class="checkbox-item"><input type="checkbox" id="chk_air" checked>ì—ì–´ì»¨ë¦¬ëª¨ì»¨</label>
           <label class="checkbox-item"><input type="checkbox" id="chk_heat" checked>ì „ì—´ë¦¬ëª¨ì»¨</label>
           <label class="checkbox-item"><input type="checkbox" id="chk_kt" checked>KTì…‹íƒ‘</label>
        </div>

        <div class="section-divider"></div>

        <div style="background:#fff2cc; padding:10px; border-radius:4px; text-align:center;">
           <label style="margin:0; font-weight:bold;">ì •ì‚° ì´ì•¡ (ê³µì œ í•©ê³„)</label>
           <div id="disp_deduct_total" style="font-size:16px; font-weight:bold; color:#d93025;">0</div>
           <hr style="border-top:1px dashed #ccc; margin:5px 0;">
           <label style="margin:0; font-weight:bold;">ìµœì¢… ë°˜í™˜ ê¸ˆì•¡</label>
           <div id="disp_final_refund" style="font-size:20px; font-weight:bold; color:#1a73e8;">0</div>
        </div>

        <button type="button" class="btn-primary" onclick="requestSettlementDownload(event)">ğŸ–¨ï¸ ì •ì‚°ì„œ ìƒì„±/ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>


    <script>
      // --- ì „ì—­ ë³€ìˆ˜ ---
      let roomDataList = [];
      let currentRoomStatus = {}; 
      let settlementBaseInfo = {}; 
      
      // --- ì´ˆê¸°í™” ---
      document.addEventListener('DOMContentLoaded', function() {
        console.log("Sidebar initialized");
        google.script.run
          .withSuccessHandler(initRooms)
          .withFailureHandler(function(err){ alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + err); })
          .getRoomListAndStatus();
      });

      function initRooms(list) {
        roomDataList = list;
        const modSel = document.getElementById("mod_hosu");
        const chgSel = document.getElementById("chg_hosu");
        
        modSel.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        chgSel.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

        list.forEach(r => {
          modSel.add(new Option(r.hosu, r.hosu));
          chgSel.add(new Option(r.hosu, r.hosu));
          currentRoomStatus[r.hosu] = r.isVacancy;
        });
      }

      function openTab(evt, tabName) {
        document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
        document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        if(evt) evt.currentTarget.classList.add("active");
      }

      // ==========================================
      // [ê³µí†µ ìœ í‹¸ë¦¬í‹°] í¬ë§·íŒ… í•¨ìˆ˜ë“¤
      // ==========================================
      
      function formatMoney(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if(value) input.value = Number(value).toLocaleString();
        else input.value = '';
      }

      function formatPhone(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        let formatted = '';
        if (value.length < 4) formatted = value;
        else if (value.length < 7) formatted = value.substr(0, 3) + '-' + value.substr(3);
        else if (value.length < 11) formatted = value.substr(0, 3) + '-' + value.substr(3, 3) + '-' + value.substr(6);
        else formatted = value.substr(0, 3) + '-' + value.substr(3, 4) + '-' + value.substr(7);
        input.value = formatted;
      }

      function formatBiz(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        let formatted = '';
        if (value.length < 4) formatted = value;
        else if (value.length < 6) formatted = value.substr(0, 3) + '-' + value.substr(3);
        else formatted = value.substr(0, 3) + '-' + value.substr(3, 2) + '-' + value.substr(5);
        input.value = formatted;
      }

      function addSimpleInput(parentId, className, ph) {
        const div = document.createElement("input");
        div.type = "text";
        div.className = className;
        div.placeholder = ph;
        div.style.marginTop = "5px";
        document.getElementById(parentId).appendChild(div);
      }

      function toggleBizNameChg(el) {
        const nameInput = document.getElementById("chg_bizName");
        if(el.value.length > 0) nameInput.classList.remove("hidden");
        else nameInput.classList.add("hidden");
      }

      function toggleBizNameMod(el) {
        const nameInput = document.getElementById("mod_bizName");
        if(el.value.length > 0) nameInput.classList.remove("hidden");
        else nameInput.classList.add("hidden");
      }

      // ==========================================
      // [ê¸°ëŠ¥ 1] ìˆ˜ì •í•˜ê¸° (Modify)
      // ==========================================
      
      function loadModData() {
        const hosu = document.getElementById("mod_hosu").value;
        if(!hosu) return;
        
        google.script.run
          .withSuccessHandler(data => {
            if(!data) return alert("ë°ì´í„° ì—†ìŒ");
            window.modCurrentData = data; 
            document.getElementById("mod_form_area").classList.remove("hidden");
            document.querySelectorAll('.mod-chk').forEach(c => c.checked = false);
            document.getElementById("mod_dynamic_inputs").innerHTML = "";
          })
          .withFailureHandler(err => alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err))
          .getRoomDetail(hosu);
      }

      document.querySelectorAll('.mod-chk').forEach(chk => {
        chk.addEventListener('change', renderModInputs);
      });

      function renderModInputs() {
        const container = document.getElementById("mod_dynamic_inputs");
        container.innerHTML = "";
        const data = window.modCurrentData; 
        
        // [ìˆ˜ì •] Mì—´(ì£¼ë¯¼ë²ˆí˜¸, ì¸ë±ìŠ¤12) ì¶”ê°€ ë° ì¸ë±ìŠ¤ ì¡°ì •
        const idxMap = {
          'bizNum': 2, 'deposit2': 5, 'rent': 6, 'parking': 7, 
          'food': 8, 'period': 9, 'tenant': 11, 
          'resNo': 12,  // â˜… [ì‹ ê·œ] ì£¼ë¯¼ë²ˆí˜¸ (Mì—´)
          'phone': 13,  // ê¸°ì¡´ 12 -> 13 (Nì—´)
          'trust': 14,  // ê¸°ì¡´ 13 -> 14 (Oì—´)
          'out': 15     // ê¸°ì¡´ 14 -> 15 (Pì—´)
        };

        const checkedBoxes = document.querySelectorAll('.mod-chk:checked');
        
        checkedBoxes.forEach(chk => {
          const key = chk.value;
          const currentVal = data[idxMap[key]] || "";
          
          let html = `<div style="margin-bottom:15px; border-left:3px solid var(--primary); padding-left:12px;">`;
          
          switch(key) {
            case 'period': 
              html += `
                <label>ì„ëŒ€ê¸°ê°„ <span class="current-value-info">(í˜„ì¬: ${currentVal})</span></label>
                <div class="row">
                  <div class="col"><input type="date" class="mod-period-start"></div>
                  <div class="col"><input type="date" class="mod-period-end"></div>
                </div>`;
              break;

            case 'parking': 
              html += `
                <label>ì£¼ì°¨ë²ˆí˜¸ <span class="current-value-info">(í˜„ì¬: ${currentVal})</span></label>
                <div id="mod_parking_list">
                  <input type="text" class="mod-parking-item" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ì…ë ¥">
                </div>
                <button type="button" class="btn-small" onclick="addSimpleInput('mod_parking_list', 'mod-parking-item', 'ì°¨ëŸ‰ë²ˆí˜¸')">+ ì¶”ê°€</button>
              `;
              break;

            case 'tenant':
              html += `
                <label>ê³„ì•½ì <span class="current-value-info">(í˜„ì¬: ${currentVal})</span></label>
                <div id="mod_tenant_list">
                  <input type="text" class="mod-tenant-item" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <button type="button" class="btn-small" onclick="addSimpleInput('mod_tenant_list', 'mod-tenant-item', 'ì´ë¦„')">+ ì¶”ê°€</button>
              `;
              break;
            
            case 'bizNum':
              html += `
                <label>ì‚¬ì—…ìì •ë³´ <span class="current-value-info">(í˜„ì¬: ${currentVal})</span></label>
                <div class="row">
                  <div class="col"><input type="text" id="mod_bizNum" placeholder="ì‚¬ì—…ìë²ˆí˜¸" oninput="toggleBizNameMod(this); formatBiz(this)"></div>
                  <div class="col"><input type="text" id="mod_bizName" placeholder="ìƒí˜¸ëª…" class="hidden"></div>
                </div>
              `;
              break;

            case 'food':
            case 'trust':
            case 'out':
              const labelMap = {'food':'ìŒì‹ë¬¼ì¹´ë“œ', 'trust':'ì‹ íƒë™ì˜', 'out':'ì¤‘ë„í‡´ì‹¤'};
              html += `
                <label>${labelMap[key]} <span class="current-value-info">(í˜„ì¬: ${currentVal})</span></label>
                <select class="mod-select-${key}">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="O">O (ìˆìŒ/ì§€ê¸‰)</option>
                  <option value="X">X (ì—†ìŒ/ë¯¸ì§€ê¸‰)</option>
                </select>
              `;
              break;

            default: 
              const labels = {'deposit2':'ë³´ì¦ê¸ˆ', 'rent':'ì›”ì„¸', 'phone':'ì—°ë½ì²˜', 'resNo':'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸'};
              let onInputAttr = "";
              let displayVal = currentVal;

              if(key === 'deposit2' || key === 'rent') {
                 onInputAttr = 'oninput="formatMoney(this)"';
                 if(displayVal && !isNaN(displayVal.toString().replace(/,/g, ''))) {
                   displayVal = Number(displayVal.toString().replace(/,/g, '')).toLocaleString();
                 }
              } else if(key === 'phone') {
                 onInputAttr = 'oninput="formatPhone(this)"';
              }

              html += `
                <label>${labels[key] || key} <span class="current-value-info">(í˜„ì¬: ${currentVal})</span></label>
                <input type="text" class="mod-input-${key}" value="${displayVal}" ${onInputAttr}>
              `;
          }
          html += `</div>`;
          container.insertAdjacentHTML('beforeend', html);
        });
      }

      function submitModify() {
        const hosu = document.getElementById("mod_hosu").value;
        if(!hosu) return alert("í˜¸ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

        let formData = { hosu: hosu };
        const checkedBoxes = document.querySelectorAll('.mod-chk:checked');
        if(checkedBoxes.length === 0) return alert("ìˆ˜ì •í•  í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì²´í¬í•˜ì„¸ìš”.");

        checkedBoxes.forEach(chk => {
          const key = chk.value;
          
          if (key === 'period') {
            const s = document.querySelector('.mod-period-start').value;
            const e = document.querySelector('.mod-period-end').value;
            if(s && e) formData.period = `${s} ~ ${e}`;
          } 
          else if (key === 'parking') {
            const arr = Array.from(document.querySelectorAll('.mod-parking-item')).map(i=>i.value).filter(v=>v);
            formData.parking = arr.join(", ");
          } 
          else if (key === 'tenant') {
            const arr = Array.from(document.querySelectorAll('.mod-tenant-item')).map(i=>i.value).filter(v=>v);
            formData.tenant = arr.join(", ");
          }
          else if (key === 'bizNum') {
            const num = document.getElementById('mod_bizNum').value;
            const name = document.getElementById('mod_bizName').value;
            formData.bizNum = num;       
            if(name) {
                formData.bizName = name; 
            }
          }
          else if (['food', 'trust', 'out'].includes(key)) {
            formData[key] = document.querySelector(`.mod-select-${key}`).value;
          }
          else {
            let val = document.querySelector(`.mod-input-${key}`).value;
            if(key === 'deposit2' || key === 'rent') {
               val = val.replace(/,/g, ''); 
            }
            formData[key] = val;
          }
        });

        google.script.run
          .withSuccessHandler(alert)
          .withFailureHandler(err => alert("ìˆ˜ì • ì‹¤íŒ¨: " + err))
          .updateRentalInfo(formData);
      }


      // ==========================================
      // [ê¸°ëŠ¥ 2] ë³€ê²½í•˜ê¸° (Change)
      // ==========================================
      
      function checkVacancy() {
        const hosu = document.getElementById("chg_hosu").value;
        const isVacant = currentRoomStatus[hosu];
        const indicator = document.getElementById("status_indicator");
        const exitArea = document.getElementById("exit_date_area");
        const newInfoArea = document.getElementById("new_info_area");

        if(!hosu) { newInfoArea.classList.add("hidden"); return; }
        
        newInfoArea.classList.remove("hidden");
        if(isVacant) {
          indicator.innerText = "â„¹ï¸ í˜„ì¬ ìƒíƒœ: ê³µì‹¤ (í‡´ì‹¤ì¼ ì…ë ¥ ë¶ˆí•„ìš”)";
          indicator.style.color = "#1a73e8"; 
          exitArea.classList.add("hidden");
        } else {
          indicator.innerText = "âš ï¸ í˜„ì¬ ìƒíƒœ: ì„¸ì…ì ìˆìŒ (í‡´ì‹¤ì¼ í•„ìˆ˜)";
          indicator.style.color = "#d93025"; 
          exitArea.classList.remove("hidden");
        }
      }

      function renderNewForm() {
        const type = document.getElementById("newType").value;
        const container = document.getElementById("chg_dynamic_inputs");
        container.innerHTML = "";

        // 1. ê³µì‹¤ ì„ íƒ ì‹œ
        if(type === 'ê³µì‹¤') {
          container.innerHTML = "<p style='color:#666;'>í•´ë‹¹ í˜¸ìˆ˜ë¥¼ 'ê³µì‹¤' ìƒíƒœë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>";
          return;
        }

        // 2. ê¸°ë³¸ ì…ë ¥í¼ (ê³„ì•½ì, ì£¼ë¯¼ë²ˆí˜¸, ì‚¬ì—…ì, ì—°ë½ì²˜ ë“±)
        let html = `
          <label>ê³„ì•½ì</label>
          <div id="chg_tenant_list">
            <input type="text" class="chg-tenant-item" placeholder="ì´ë¦„ ì…ë ¥">
          </div>
          <button type="button" class="btn-small" onclick="addSimpleInput('chg_tenant_list', 'chg-tenant-item', 'ì´ë¦„')">+ ì¶”ê°€</button>
          
          <label style="margin-top:10px;">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label>
          <input type="text" id="chg_resNo" placeholder="ì£¼ë¯¼ë²ˆí˜¸ (ex. 900101-1234567)">
        `;

        // ì „ì„¸ê°€ ì•„ë‹ ê²½ìš° ì‚¬ì—…ì ì •ë³´ ì…ë ¥ì°½ í‘œì‹œ
        if(type !== 'ì „ì„¸') {
          html += `
            <label>ì‚¬ì—…ìì •ë³´</label>
            <div class="row">
              <div class="col"><input type="text" id="chg_bizNum" placeholder="ì‚¬ì—…ìë²ˆí˜¸" oninput="toggleBizNameChg(this); formatBiz(this)"></div>
              <div class="col"><input type="text" id="chg_bizName" placeholder="ìƒí˜¸ëª…" class="hidden"></div>
            </div>
          `;
        }

        html += `<label>ì—°ë½ì²˜</label><input type="text" id="chg_phone" oninput="formatPhone(this)" placeholder="010-0000-0000">`;

        // ë§¤ë§¤ì¼ ê²½ìš° ì”ê¸ˆì¼, ê·¸ ì™¸ì—ëŠ” ì„ëŒ€ê¸°ê°„
        if(type === 'ë§¤ë§¤') {
          html += `<label>ì”ê¸ˆì¼</label><input type="date" id="chg_balanceDate">`;
        } else {
          html += `
            <label>ì„ëŒ€ê¸°ê°„</label>
            <div class="row">
              <div class="col"><input type="date" id="chg_periodStart"></div>
              <div class="col"><input type="date" id="chg_periodEnd"></div>
            </div>
          `;
        }

        // ë³´ì¦ê¸ˆ/ì›”ì„¸ ì…ë ¥ì°½ (ìœ í˜•ë³„ ë¶„ê¸°)
        if(type.includes("ì›”ì„¸")) {
          html += `<label>ë³´ì¦ê¸ˆ</label><input type="text" id="chg_deposit2" oninput="formatMoney(this)">`;
          html += `<label>ì›”ì„ëŒ€ë£Œ</label><input type="text" id="chg_rent" oninput="formatMoney(this)">`;
        } else if(type === 'ì „ì„¸') {
          html += `<label>ì „ì„¸ë³´ì¦ê¸ˆ</label><input type="text" id="chg_deposit1" oninput="formatMoney(this)">`;
        }

        // 3. í•˜ë‹¨ ì˜µì…˜ (ì£¼ì°¨, ìŒì‹ë¬¼, ì‹ íƒ, ì¤‘ë„í‡´ì‹¤)
        html += `
          <label>ì£¼ì°¨</label>
          <div id="chg_parking_list">
            <input type="text" class="chg-parking-item" placeholder="ì°¨ëŸ‰ë²ˆí˜¸">
          </div>
          <button type="button" class="btn-small" onclick="addSimpleInput('chg_parking_list', 'chg-parking-item', 'ì°¨ëŸ‰ë²ˆí˜¸')">+ ì¶”ê°€</button>

          <div class="row" style="margin-top:15px;">
            
            <div class="col">
              <label>ìŒì‹ë¬¼</label>
              <select id="chg_food">
                <option value="O" selected>O</option>
                <option value="X">X</option>
              </select>
            </div>

            <div class="col">
              <label>ì‹ íƒ</label>
              <select id="chg_trust">
                <option value="X" selected>X</option>
                <option value="O">O</option>
                <option value="">-</option>
              </select>
            </div>

            <div class="col">
              <label>ì¤‘ë„í‡´ì‹¤</label>
              <select id="chg_out">
                <option value="X" selected>X</option>
                <option value="O">O</option>
                <option value="">-</option>
              </select>
            </div>

          </div>
        `;

        container.innerHTML = html;
      }

      function submitChange() {
        const hosu = document.getElementById("chg_hosu").value;
        const newType = document.getElementById("newType").value;
        if(!hosu || !newType) return alert("í•„ìˆ˜ í•­ëª© ëˆ„ë½: í˜¸ìˆ˜ ë˜ëŠ” ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.");

        const isVacant = currentRoomStatus[hosu];
        const exitDate = document.getElementById("exitDate").value;
        if(!isVacant && !exitDate) return alert("ê¸°ì¡´ ì„¸ì…ìì˜ í‡´ì‹¤ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");

        let formData = { hosu, newType, isPreviouslyVacant: isVacant, exitDate };

        if(newType !== 'ê³µì‹¤') {
          const tenants = Array.from(document.querySelectorAll('.chg-tenant-item')).map(i=>i.value).filter(v=>v);
          if(tenants.length === 0) return alert("ê³„ì•½ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
          formData.tenantFinal = tenants.join(", "); 
          
          const bizNum = document.getElementById("chg_bizNum") ? document.getElementById("chg_bizNum").value : "";
          const bizName = document.getElementById("chg_bizName") ? document.getElementById("chg_bizName").value : "";
          
          if(bizNum) {
             formData.bizNum = bizNum; 
          }

          if(bizName) {
             if(formData.tenantFinal) {
                 formData.tenantFinal = formData.tenantFinal + `(${bizName})`;
             }
          }

          const parkings = Array.from(document.querySelectorAll('.chg-parking-item')).map(i=>i.value).filter(v=>v);
          formData.parking = parkings.join(", ");

          if(newType === 'ë§¤ë§¤') {
             formData.balanceDate = document.getElementById("chg_balanceDate").value;
          } else {
             const s = document.getElementById("chg_periodStart").value;
             const e = document.getElementById("chg_periodEnd").value;
             if(s && e) {
               formData.periodStart = s;
               formData.periodEnd = e;
             }
          }

          if(document.getElementById("chg_deposit1")) formData.deposit1 = document.getElementById("chg_deposit1").value.replace(/,/g, '');
          if(document.getElementById("chg_deposit2")) formData.deposit2 = document.getElementById("chg_deposit2").value.replace(/,/g, '');
          if(document.getElementById("chg_rent")) formData.rent = document.getElementById("chg_rent").value.replace(/,/g, '');
          
          // â˜… [ì¶”ê°€] ì£¼ë¯¼ë²ˆí˜¸ ë° ì—°ë½ì²˜
          if(document.getElementById("chg_resNo")) formData.resNo = document.getElementById("chg_resNo").value;
          if(document.getElementById("chg_phone")) formData.phone = document.getElementById("chg_phone").value;
          
          formData.food = document.getElementById("chg_food").value;
          formData.trust = document.getElementById("chg_trust").value;
          formData.out = document.getElementById("chg_out").value;
        }

        if(!confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì£¼ì˜: ê¸°ì¡´ ë°ì´í„°ëŠ” í‡´ì‹¤ ì²˜ë¦¬ë©ë‹ˆë‹¤)")) return;
        
        google.script.run
          .withSuccessHandler(function(res) {
            alert(res.message); 
            
            const isTenantChanged = (res.oldTenant && res.newTenant && res.oldTenant.trim() !== res.newTenant.trim());

            if (!res.isPreviouslyVacant && isTenantChanged) {
              if(confirm(`ì„¸ì…ìê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ì–´ì„œ '${res.hosu}í˜¸' í‡´ì‹¤ ì •ì‚°ì„œë¥¼ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                 openSettlementOverlay(res.hosu, res.oldDeposit, res.exitDate, res);
              } else {
                 location.reload();
              }
            } else {
              location.reload();
            }
          })
          .withFailureHandler(err => alert("ë³€ê²½ ì‹¤íŒ¨: " + err))
          .changeRentalStatus(formData);
      }


      // ==========================================
      // [ê¸°ëŠ¥ 3] ì •ì‚°ì„œ ì˜¤ë²„ë ˆì´ ë¡œì§
      // ==========================================
      
      let settlementBaseInfoData = {}; 

      // 1. ì˜¤ë²„ë ˆì´ ì—´ê¸°/ë‹«ê¸°
      function openSettlementOverlay(hosu, oldDeposit, exitDate, newInfoObj = null) {
        const overlay = document.getElementById("settlement_overlay");
        overlay.classList.add("active");
        overlay.dataset.hosu = hosu;
        document.getElementById("settle_info_msg").innerText = `${hosu}í˜¸ (${exitDate} í‡´ì‹¤)`;

        document.getElementById("set_deposit").value = "ê³„ì‚° ì¤‘...";
        
        // ì„œë²„ì— ê³„ì‚° ìš”ì²­ (newInfoObjë„ í•¨ê»˜ ì „ë‹¬)
        google.script.run
          .withSuccessHandler(initSettlementForm)
          .withFailureHandler(err => alert("ê³„ì‚° ì‹¤íŒ¨: " + err))
          .getSettlementCalcData(hosu, exitDate, newInfoObj);
      }
      
      function closeSettlement() {
        document.getElementById("settlement_overlay").classList.remove("active");
        location.reload();
      }

      // 2. ì´ˆê¸° ë°ì´í„° ì„¸íŒ…
      function initSettlementForm(data) {
        settlementBaseInfo = data; 
        
        // ë³´ì¦ê¸ˆ
        setVal("set_deposit", data.info.deposit);
        
        // ì„ ë¶ˆ ì„ëŒ€ë£Œ ë°˜í™˜
        var refundVal = data.rent.prepaidRefund || data.rent.prepaid || 0;

        if (refundVal > 0) { 
           document.getElementById("prepaid_rent_area").classList.remove("hidden");
           setVal("set_refund_prepaid", refundVal);
        } else {
           document.getElementById("prepaid_rent_area").classList.add("hidden");
           setVal("set_refund_prepaid", 0);
        }

        // ì„ëŒ€ë£Œ ê³µì œ (ê¸°ì¡´ ì„¸ì…ì ê¸°ì¤€)
        setVal("set_rent_deduct", data.rent.amount);
        document.getElementById("set_rent_period").value = data.rent.period;
        
        // ê´€ë¦¬ë¹„ ê³µì œ
        setVal("set_maint_deduct", data.maint.amount);
        document.getElementById("set_maint_period").value = data.maint.period;

        // ìœ ë³´ê¸ˆ ê¸°ë³¸ê°’
        setVal("set_retained", 100000);
        
        // ê³µê³¼ê¸ˆ ê¸°ê°„ í‘œì‹œ
        const exitDateShort = data.date.substring(2); 
        if(document.getElementById("util_elec_period")) document.getElementById("util_elec_period").innerText = "~ " + exitDateShort;
        if(document.getElementById("util_gas_period")) document.getElementById("util_gas_period").innerText = "~ " + exitDateShort;
        if(document.getElementById("util_water_period")) document.getElementById("util_water_period").innerText = "~ " + exitDateShort;

        // ì´ì•¡ ê³„ì‚°
        calcTotalRefund();
      }

      // 3. UI ë™ì  ì œì–´ ë° ê³„ì‚°
      
      function calcBrokerFee() {
        const opt = document.getElementById("broker_opt").value;
        const input = document.getElementById("set_broker_fee");
        
        // 1. ì˜µì…˜ í™•ì¸ (ì—†ìŒ/ì§ì ‘ì…ë ¥ ì²˜ë¦¬)
        if (opt === 'none') {
          input.classList.add("hidden");
          input.value = 0;
          calcTotalRefund();
          return;
        } else if (opt === 'direct') {
          input.classList.remove("hidden");
          input.value = "";
          input.placeholder = "ì§ì ‘ ì…ë ¥";
          calcTotalRefund();
          return;
        }
        
        // [ê´€ë¦¬ì‹¤ ì •ì‚° - ìë™ê³„ì‚° ë¡œì§ ì‹œì‘]
        input.classList.remove("hidden");
        
        // 2. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const info = settlementBaseInfo.info || {};    
        const newInfo = settlementBaseInfo.newInfo || {}; 
        
        // 3. ê¸ˆì•¡ ê²°ì • (ë¬´ì¡°ê±´ ì‹ ê·œ ì„¸ì…ì ê¸ˆì•¡ ìš°ì„ !)
        let deposit = 0;
        let rent = 0;

        if (newInfo.newDeposit !== undefined && String(newInfo.newDeposit).trim() !== "") {
            deposit = Number(String(newInfo.newDeposit).replace(/,/g, ''));
            rent = Number(String(newInfo.newRent || 0).replace(/,/g, ''));
        } else {
            // ì‹ ê·œ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ì •ë³´ ì‚¬ìš©
            deposit = Number(String(info.deposit || 0).replace(/,/g, ''));
            rent = Number(String(info.rent || 0).replace(/,/g, ''));
        }

        // 4. ìš©ë„ ë° ê³„ì•½ í˜•íƒœ í™•ì¸
        const bizType = String(newInfo.fixedBizType || info.bizType || "ë„ì‹œí˜•ìƒí™œì£¼íƒ"); 
        const rentType = String(newInfo.newType || info.type || "");

        console.log(`[ê³„ì‚° ê¸°ì¤€] ê±´ë¬¼:${bizType}, ìœ í˜•:${rentType}, ë³´ì¦ê¸ˆ:${deposit}, ì›”ì„¸:${rent}`);

        // 5. ì •ë°€ ê³„ì‚° ë¡œì§
        let pureFee = 0; 
        const baseAmount = deposit + (rent * 100); 

        // CASE 1: ê·¼ë¦°ìƒí™œì‹œì„¤ (0.9%)
        if (bizType.includes("ê·¼ë¦°") || bizType.includes("ìƒê°€")) {
            pureFee = (baseAmount * 9) / 1000; 
        }
        // CASE 2 & 3: ì˜¤í”¼ìŠ¤í…” (0.4%)
        else if (bizType.includes("ì˜¤í”¼ìŠ¤í…”")) {
            if (rentType.includes("ì „ì„¸")) {
                pureFee = (deposit * 4) / 1000;
            } else {
                pureFee = (baseAmount * 4) / 1000;
            }
        }
        // CASE 4 & 5: ë„ì‹œí˜•ìƒí™œì£¼íƒ (0.3%)
        else {
            if (rentType.includes("ì „ì„¸")) {
                pureFee = (deposit * 3) / 1000;
            } else {
                pureFee = (baseAmount * 3) / 1000;
            }
        }

        // 6. ë¶€ê°€ì„¸ ê³„ì‚°
        pureFee = Math.floor(pureFee);
        const vat = Math.floor(pureFee / 10); 
        const totalFee = pureFee + vat;

        // 7. ê²°ê³¼ê°’ ì…ë ¥
        setVal("set_broker_fee", totalFee);
        calcTotalRefund();
      }

      // ì´ ë°˜í™˜ê¸ˆ ê³„ì‚°
      function calcTotalRefund() {
        const getV = (id) => Number(document.getElementById(id).value.replace(/,/g, '')) || 0;
        
        const asset = getV("set_deposit") + getV("set_refund_prepaid");
        
        let deduct = getV("set_rent_deduct") + getV("set_maint_deduct");
        
        if(document.querySelector('input[name="util_method"]:checked').value === 'office') {
           deduct += getV("util_elec") + getV("util_gas") + getV("util_water");
        }
        
        deduct += getV("set_broker_fee");
        deduct += (document.getElementById("chk_clean").checked ? 300000 : 0);
        deduct += (document.getElementById("chk_filter").checked ? 30000 : 0);
        deduct += getV("set_retained");
        
        document.querySelectorAll(".as-amount").forEach(el => {
           deduct += (Number(el.value.replace(/,/g,'')) || 0);
        });

        document.getElementById("disp_deduct_total").innerText = deduct.toLocaleString();
        document.getElementById("disp_final_refund").innerText = (asset - deduct).toLocaleString();
      }

      // UI í† ê¸€ (ê³µê³¼ê¸ˆ)
      function toggleUtilInput(show) {
         const div = document.getElementById("util_inputs");
         if(show) div.classList.remove("hidden"); else div.classList.add("hidden");
         calcTotalRefund();
      }
      
      // UI í† ê¸€ (ê³ ì •ë¹„ìš©)
      function toggleFixCost(type, amount) { calcTotalRefund(); }
      
      // UI ì¶”ê°€ (AS í•­ëª©)
      function addAsItem() {
         const div = document.createElement("div");
         div.className = "row"; div.style.marginTop = "5px";
         div.innerHTML = `<div class="col" style="flex:2"><input type="text" class="as-name" placeholder="í•˜ì ë‚´ìš©"></div><div class="col" style="flex:1"><input type="text" class="as-amount" placeholder="ê¸ˆì•¡" oninput="formatMoney(this); calcTotalRefund()"></div>`;
         document.getElementById("as_list").appendChild(div);
      }
      
      function setVal(id, val) { document.getElementById(id).value = Number(val).toLocaleString(); }

      // 4. ë°ì´í„° ì „ì†¡ (ë‹¤ìš´ë¡œë“œ ìš”ì²­)
      function requestSettlementDownload(event) {
         const getV = (id) => document.getElementById(id).value;
         
         const data = {
           hosu: settlementBaseInfo.hosu,
           date: settlementBaseInfo.date, 
           rentType: settlementBaseInfo.info.type,
           deposit: getV("set_deposit"),
           prepaidRefund: getV("set_refund_prepaid"),
           rent: { amount: getV("set_rent_deduct"), period: getV("set_rent_period") },
           maint: { amount: getV("set_maint_deduct"), period: getV("set_maint_period") },
           utils: { elec: getV("util_elec"), gas: getV("util_gas"), water: getV("util_water") },
           brokerFee: getV("set_broker_fee"),
           repair: {
               clean: document.getElementById("chk_clean").checked ? "300,000" : "",
               filter: document.getElementById("chk_filter").checked ? "30,000" : "",
               asItems: []
           },
           retained: getV("set_retained"),
           totalDeduct: document.getElementById("disp_deduct_total").innerText,
           finalRefund: document.getElementById("disp_final_refund").innerText,
           bank: { name: document.getElementById("bank_name").value, account: getV("bank_account"), owner: getV("bank_owner") },
           checks: {
               key: document.getElementById("chk_key").checked,
               food: document.getElementById("chk_food").checked,
               air: document.getElementById("chk_air").checked,
               heat: document.getElementById("chk_heat").checked,
               kt: document.getElementById("chk_kt").checked
           }
         };
         
         document.querySelectorAll("#as_list .row").forEach(row => {
            data.repair.asItems.push({ name: row.querySelector(".as-name").value, amount: row.querySelector(".as-amount").value });
         });

         const btn = event.target;
         btn.disabled = true; btn.innerText = "â³ ìƒì„± ì¤‘...";
         
         google.script.run
           .withSuccessHandler(url => {
              window.open(url, '_blank');
              closeSettlement();
           })
           .withFailureHandler(err => {
              alert("ìƒì„± ì‹¤íŒ¨: " + err);
              btn.disabled = false; btn.innerText = "ğŸ–¨ï¸ ì •ì‚°ì„œ ìƒì„±/ë‹¤ìš´ë¡œë“œ";
           })
           .createSettlementExcel(data);
      }
    </script>
  </body>
</html>